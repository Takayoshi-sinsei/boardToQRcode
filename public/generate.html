document.getElementById('generateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const projectNo = document.getElementById('projectNo').value;
    const token = localStorage.getItem('token');
    try {
        const [qrResponse, projectInfo] = await Promise.all([
            fetch('/api/generate', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ taskId: projectNo })
            }),
            fetchProjectInfo(projectNo)
        ]);

        if (!qrResponse.ok) {
            throw new Error(`QR生成エラー: ${qrResponse.status}`);
        }

        const qrData = await qrResponse.json();
        document.getElementById('qrCode').innerHTML = `<img src="${qrData.qrCode}" alt="QR Code">`;
        
        if (projectInfo) {
            document.getElementById('printProjectNo').textContent = `案件No: ${projectNo}`;
            document.getElementById('printProjectName').textContent = `案件名: ${projectInfo.projectName}`;
            document.getElementById('printClientName').textContent = `クライアント名: ${projectInfo.clientName}`;
            document.getElementById('printContactName').textContent = `担当者名: ${projectInfo.contactName}`;
            document.getElementById('printButton').style.display = 'block';
        } else {
            throw new Error('プロジェクト情報を取得できませんでした');
        }
    } catch (error) {
        console.error('Error:', error);
        alert(`エラーが発生しました: ${error.message}`);
    }
});